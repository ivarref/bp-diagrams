<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 12px sans-serif;
}
svg {
  font: 12px sans-serif;
  border: 1px solid #000;
}

text.heading {
  font: 22px sans-serif;
}

.cmpdot {
  fill: lightsalmon;
  stroke: black;
  stroke-width: 1.0px;
}

.line {
  fill: none;
  stroke: black;
  stroke-width: 3.0px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

rect {
  shape-rendering: crispEdges;
}

span.advancedmode {
  color: -webkit-link;
  text-decoration: underline;
  cursor: pointer;
}

tr.advancedmode { }

</style>
<title>Energy Consumption</title>
<body>
<form method='GET' style='padding-bottom: 2px;'>
<table>
  <tr>
    <td style="min-width: 201px;">Choose country or group of nations: </td>
    <td>
      <select id='ccselect' name='cc'>
        <optgroup id='groups' label="Group of nations">
        </optgroup>
        <optgroup id='countries' label="Country">
        </optgroup>
      </select>
    <span id="showadvancedmode" class="advancedmode">Show extra options</span>
    <span id="hideadvancedmode" class="advancedmode" style="display: none;" >Hide extra options</span>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose comparison country or group: </td>
    <td>
      <select id='ccselect_vs' name='vs_cc'>
        <optgroup id='groups_vs' label="Group of nations">
          <option value='none'>None</option>
        </optgroup>
        <optgroup id='countries_vs' label="Country">
        </optgroup>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose what to show:</td>
    <td>
      <select id='mode_select' name=''>
        <option value='per_capita'>Per capita energy consumption</option>
        <option value='total'>Total energy consumption</option>
      </select>
    </td>
  </tr>
</table>
</form>
<script src="d3.v3.min.js"></script>
<script>

var format = d3.time.format("%Y")

var config = {}

function getURLParameter(name, default_value) {
  if (name in config) {
    return config[name]
  }
  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||default_value
}

function yaxismode() {
  return getURLParameter('mode', 'per_capita')
}

function mode(other, default_value) {
  return (yaxismode() === 'per_capita') ? default_value : other
}

function advanced_mode() {
  return getURLParameter('advanced_mode', 'false') === 'true';
}

function since() { return format.parse(getURLParameter('since', '1965')) }
function cc() { return getURLParameter('country_code', 'BP_WORLD') }
function cc_vs() { return getURLParameter('country_code_vs', 'none') }

d3.select('#mode_select')
  .on('change', function() { 
    var sel = document.getElementById('mode_select');
    var selected = sel.options[sel.selectedIndex].value
    config['mode'] = selected
    update()
  })
  .selectAll('option')
  .filter(function(d) { return this.value === yaxismode() })
  .attr('selected', 'selected')

d3.select('#ccselect')
  .on('change', function() { 
    var sel = document.getElementById('ccselect');
    var selected = sel.options[sel.selectedIndex].value
    config['country_code'] = selected
    update()
  })

d3.select('#ccselect_vs')
  .on('change', function() { 
    var sel = document.getElementById('ccselect_vs');
    var selected = sel.options[sel.selectedIndex].value
    config['country_code_vs'] = selected
    update()
  })

function show_advanced_mode() {
  d3.selectAll('tr.advancedmode').style('display', advanced_mode() ? '' : 'none')
  d3.selectAll('#showadvancedmode').style('display', !advanced_mode() ? '' : 'none')
  d3.selectAll('#hideadvancedmode').style('display', advanced_mode() ? '' : 'none')
}

show_advanced_mode()

var margin = {top: 55, right: 55, bottom: 35, left: 30},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var color = d3.scale.ordinal()
color.range(
  ["gray"
  ,d3.rgb(24, 116, 24)
  ,d3.rgb(254, 24, 24)
  ,"cyan"
  ,"#36f"
  ,"#c0f"
  ,"yellow"
  ,"#960"])

var y = d3.scale.linear()
    .range([height, 0])

var x = d3.time.scale()
    .range([0, width])

var svg_root = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

var svg = svg_root.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

var area = d3.svg.area()
    .x(function(d) { return x(d.year); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var stack = d3.layout.stack()
  .values(function(d) { return d.values; });

var countrycodes = {}

var all_data = null;

  var infoheight = 8 + 16*8

  var pal = svg.append('g')

  var info = svg.append("g")
    .attr("transform", "translate(20," + (20) + ")")

  info.append('rect')
    .attr('x', 0)
    .attr('y', 0)
    .attr('width', 130)
    .attr('height', infoheight)
    .style('fill', '#eee')
    .style('fill-opacity', '60%')
    .style('stroke', 'black')
    .style('stroke-opacity', '100%')

function selectSingle(root, id) {
    var sel = root.selectAll(id).data([1]);
    var t = {
        'enter' : function(fn) { fn(sel.enter()); return t },
        'update' : function(fn) { fn(sel); return t },
        'call' : function(fn) { sel.call(fn); return t },
        'selection' : function() { return sel },
        'text' : function(txt) { sel.text(txt); return t }
    }
    return t
}

function update() {
  var data = all_data.filter(function(d) { return d.country_code === cc() && d.year >= since() })
  var minyear = d3.min(data.map(function(d) { return d.year }))
  var secondary_data = all_data.filter(function(d) { return d.country_code === cc_vs() && d.year >= minyear })
  var pas_data = all_data.filter(function(d) { return (d.country_code === cc() || d.country_code === cc_vs()) && d.year >= minyear })
  var country_readable = countrycodes[data[0].country_code]

  country_readable = country_readable.split(",")[0]

  selectSingle(svg, '#heading')
  .enter(function(sel) {
       sel.append('g')
      .attr('id', 'heading')
      .append('text')
      .attr('class', 'heading')
      .attr('dy', '-1.11em')
   })
   .update(function(sel) {
      var infotext = mode("Total Energy Consumption", "Per Capita Energy Consumption")
      sel.select('text').text(country_readable + " " + infotext + " " + minyear.getFullYear() + " - 2013")
   })

  selectSingle(svg, '#sourceExplanation')
  .enter(function(sel) { 
    sel
    .append('text')
    .attr('id', 'sourceExplanation') 
    .attr('dy', '-.51em')
  })
  .text('Data from BP Statistical Review' + mode('', ' and World Bank') + '.')

  var resources = "coal,oil,gas,nuclear,hydro,other_renewables,solar,wind".split(",")
  color.domain(resources)
  y.domain([0, d3.max(pas_data.map(function(d) { 
    var p = mode(1.0, (d.population / 1000000.0))
    return (d.coal + d.gas + d.hydro + d.nuclear + d.oil + d.other_renewables + d.solar + d.wind) / p
  }))])
  x.domain(d3.extent(data.map(function(d) { return d.year })))

  var cmp_line = secondary_data.map(function(d) {
    var p = mode(1.0, (d.population / 1000000.0))
    return {x : d.year, y : ((d.coal + d.gas + d.hydro + d.nuclear + d.oil + d.other_renewables + d.solar + d.wind) / p) }
  })

  var resource_stack = stack(resources.map(function(resource) {
    return {
      name: resource,
      values: data.map(function(d) { 
        var p = mode(1.0, (d.population / 1000000.0))
      return { year: d.year, y: d[resource]/p } })
      }
  }))

  selectSingle(svg, '#yAxisLabel')
    .enter(function(sel) { 
      sel.append('text')
      .attr('id', 'yAxisLabel')
      .style('text-anchor', 'middle')
      .attr('transform', 'translate(' + width + ',0)')
      .attr('dy', '-.71em')
      })
    .text(mode('MTOE/a', 'TOE/a'))

  selectSingle(svg, '.x.axis')
  .enter(function(sel) {
    sel.append('g')
    .attr('class', 'x axis')
    .attr("transform", "translate(0," + height + ")")
  })
  .call(d3.svg.axis().scale(x).orient("bottom"))

  selectSingle(pal, '.y.axis')
  .enter(function(sel) {
    sel.append('g')
    .attr('class', 'y axis')
    .attr("transform", "translate(" + width + ",0)")
  })
  .call(d3.svg.axis().scale(y).orient("right"))

  var energy = pal.selectAll(".energy") .data(resource_stack)
  energy.enter().append("g")
  .attr("class", "energy")
  .append("path")
  .attr("class", "area")

  energy.select('path')
  .attr("d", function(d) { return area(d.values); })
  .style("fill", function(d) { return color(d.name); });

  selectSingle(pal, '#cmpLine')
  .enter(function(sel) {
    sel.append('path')
    .attr('id', 'cmpLine')
    .attr('class', 'line')
  })
  .selection()
  .datum(cmp_line)
  .attr('d', 
    d3.svg.line(cmp_line)
    .x(function(d) { return x(d.x) })
    .y(function(d) { return y(d.y) })
  )

  var sel = selectSingle(pal, '#cmpdots')
  .enter(function(sel) {
    sel.append('g')
    .attr('id', 'cmpdots')
  })
  .selection()

  sel = sel.selectAll('circle').data(cmp_line)
  sel.enter().append('circle')
  sel
    .attr('class', 'cmpdot')
    .attr('cx', function(d) { return x(d.x) })
    .attr('cy', function(d) { return y(d.y) })
    .attr('r', 3.5)
  sel.exit().remove()


  var resinfo = info.selectAll('g').data(resources)
    .enter()
    .append('g')
    .attr('transform', function(d, i) { return 'translate(25,' + (16*(resources.length-i)) + ')' })

  resinfo
    .append('rect')
    .attr('x', -16)
    .attr('y', -10)
    .attr('width', 12)
    .attr('height', 12)
    .style('fill', color)
    .style('stroke', 'black')
    .style('stroke-opacity', '100%')

  function name(d) {
    return d.charAt(0).toUpperCase() + d.slice(1).replace('_', ' ');
  }

  resinfo
    .append('text')
    .text(name)

  selectSingle(svg, '#unitExplanation')
  .enter(function(sel) { 
    sel
    .append('text')
    .attr('id', 'unitExplanation') 
    .attr('transform', 'translate(0,' + height + ')') 
    .attr('dx', '.31em')
    .attr('dy', '-.31em')
    .style('fill', '#fff')
  })
  .text(mode('MTOE/a = Million Tonnes Oil Equivalents per annum.',
             'TOE/a = Tonnes Oil Equivalents per capita per annum.'))
}


d3.json('data/slim-2.json', function(error, codes) { 
codes.forEach(function(d) {
  countrycodes[d['alpha-2']] = d.name
})
// "BP_OAF",
// "BP_OAP",
// "BP_OEE",
// "BP_OME",
// "BP_OSCA",
countrycodes['BP_OECD'] = 'OECD'
countrycodes['BP_NONOECD'] = 'Non OECD'
countrycodes['BP_EU2'] = 'Eurozone'
countrycodes['BP_FSU'] = 'Total Former Soviet Union'
countrycodes['BP_TAF'] = 'Total Africa'
countrycodes['BP_TAP'] = 'Total Asia-Pacific'
countrycodes['BP_TEE'] = 'Total Europe and Eurasia'
countrycodes['BP_TME'] = 'Total Middle East'
countrycodes['BP_TNA'] = 'Total North America'
countrycodes['BP_TSCA'] = 'Total South and Central America'
countrycodes['BP_WORLD'] = 'World'

d3.tsv('data/data.tsv', function(err, data) {
  var ccs = d3.set(data.map(function(d) { return d.country_code }))
  var codes = ccs.values().filter(function(d) { return d3.keys(countrycodes).indexOf(d) != -1 })
  var rev = {}
  codes.forEach(function(d) { return rev[countrycodes[d]] = d } )

  var names = d3.keys(rev)
  names.sort()

  names.forEach(function(d) {
    var code = rev[d]
    var id = code.indexOf('BP_') == 0 ? "#groups" : "#countries"
    var option = d3.select(id)
      .append('option')
      .attr('value', rev[d])
      .text(d)

    var sel = d3.select(id + "_vs")
      .append('option')
      .attr('value', rev[d])
      .text(d)
    if (cc_vs() === code)
      sel.attr('selected', 'selected')

    if (cc() == code)
      option.attr('selected', 'selected')
  })

  data.forEach(function(d) {
    d.year = format.parse(d.year)
    d.population = +d.population
    var p = 1.0
    d.coal = +d.coal / p
    d.gas = +d.gas / p
    d.hydro = +d.hydro / p
    d.nuclear = +d.nuclear / p
    d.oil = +d.oil / p
    d.other_renewables = +d.other_renewables / p
    d.solar = +d.solar / p
    d.wind = +d.wind / p
  })

  all_data = data
  update()

  var body = d3.select('body')


  selectSingle(svg, '#contact')
  .enter(function(sel) { 
    sel
    .append('text')
    .attr('id', 'contact') 
    .attr('transform', 'translate(' + width + ',' + height + ')') 
    .attr('dx', '-.31em')
    .attr('dy', '-.31em')
    .style('text-anchor', 'end')
    .style('fill', '#fff')
  })
  .text('refsdal.ivar@gmail.com')

  d3.select('span#showadvancedmode').on('click', function() { config['advanced_mode'] = 'true'; show_advanced_mode() })
  d3.select('span#hideadvancedmode').on('click', function() { config['advanced_mode'] = 'false'; show_advanced_mode() })

  //d3.select('body').append('div').text('Permalink (URL, Image).')
})
})

</script>
</body>
