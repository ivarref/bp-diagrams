<!DOCTYPE html>
<meta charset="utf-8">
<style>
body { font: 12px sans-serif; }
svg { border: 1px solid #000; }
text.heading { font: 22px sans-serif; font-weight: bold; }
text.smallheading { font: 14px sans-serif; }
.vsfill { fill: Fuchsia; /* c0f */ }
.cmpdot { stroke: black; stroke-width: 1.0px; }
.fadedbox { fill: #eee; fill-opacity: 87%; stroke: black; }
.line { fill: none; stroke: black; stroke-width: 3.0px; }
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

rect { shape-rendering: crispEdges; }
tr.advancedmode { }
tr.simpledmode { }
</style>
<title>Energy Consumption</title>
<body>
<form method='GET' style='padding-bottom: 2px;'>
<table>
  <tr>
    <td>Choose country or group of nations: </td>
    <td>
      <select id='ccselect' name='cc' style='min-width: 222px;'>
        <optgroup id='groups' label="Group of nations"></optgroup>
        <optgroup id='countries' label="Country"></optgroup>
      </select>
    </td>
  </tr>
  <tr class="simplemode">
    <td colspan="2">
      <a href="#" onclick="showAdvancedMode(); return false;">Show more options</a>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose reference country or group: </td>
    <td>
      <select id='ccselect_vs' name='vs_cc' style='min-width: 222px;'>
        <optgroup id='groups_vs' label="Group of nations">
          <option value='none'>None</option>
        </optgroup>
        <optgroup id='countries_vs' label="Country"></optgroup>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose what to show:</td>
    <td>
      <select id='mode_select' name='' style='min-width: 222px;'>
        <option value='per_capita'>Per capita energy consumption</option>
        <option value='total'>Total energy consumption</option>
        <option value='share'>Relative share of energy consumption</option>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose resources to include:</td>
    <td id="resources_selection">
      <label><input type="checkbox" name="resources" value="coal" checked="checked">Coal</input></label>
      <label><input type="checkbox" name="resources" value="oil" checked="checked">Oil</input></label>
      <label><input type="checkbox" name="resources" value="gas" checked="checked">Gas</input></label>
      <label><input type="checkbox" name="resources" value="nuclear" checked="checked">Nuclear</input></label>
      <label><input type="checkbox" name="resources" value="hydro" checked="checked">Hydro</input></label>
      <label><input type="checkbox" name="resources" value="other_renewables" checked="checked">Other renewables</input></label>
      <label><input type="checkbox" name="resources" value="solar" checked="checked">Solar</input></label>
      <label><input type="checkbox" name="resources" value="wind" checked="checked">Wind</input></label>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td> <a href="#" onclick="hideAdvancedMode(); return false;">Hide extra options</a> </td>
    <td> <a href="#" id="permalink">Permalink to this diagram</a>
         <a href="#" id="permalink_printer">printer friendly</a>
    </td>
  </tr>
</table>
</form>
<script src="d3.v3.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56575481-1', 'auto');
  ga('send', 'pageview');

/*
http://www.w3schools.com/tags/ref_color_tryit.asp?color=white
*/
var format = d3.time.format("%Y")
var config = {}
var all_resources = "coal,oil,gas,nuclear,hydro,other_renewables,solar,wind"

function getURLParameter(name, default_value) {
  var component = decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))
  return (name in config) ? config[name] : (component||default_value).split('/')[0]
}

function yaxismode() { return getURLParameter('mode', 'per_capita') }
function advanced_mode() { return getURLParameter('advanced_mode', 'false') === 'true'; }
function since() { return format.parse(getURLParameter('since', '1965')) }
function cc() { return getURLParameter('country_code', 'BP_WORLD') }
function cc_vs() { return yaxismode()==='share' ? 'none' : getURLParameter('country_code_vs', 'none') }

function mode(other, default_value, share_mode) { 
   if (yaxismode() === 'per_capita') 
    return default_value
   else if (yaxismode() ==='total') 
    return other
   else if (yaxismode() ==='share') 
    return share_mode
}

function set_selected(attr, from_id) {
  return function() {
    var sel = document.getElementById(from_id)
    var selected = sel.options[sel.selectedIndex].value
    config[attr] = selected
    update()
  }
}

d3.select('#ccselect').on('change', set_selected('country_code', 'ccselect'))
d3.select('#ccselect_vs').on('change', set_selected('country_code_vs', 'ccselect_vs'))

d3.select('#mode_select').on('change', set_selected('mode', 'mode_select'))
  .selectAll('option')
  .filter(function(d) { return this.value === yaxismode() })
  .attr('selected', 'selected')

d3.select('#resources_selection')
  .selectAll('input')
  .attr('checked', function(d) { return (getURLParameter('resources', all_resources).split(",").indexOf(this.value) != -1) ? 'checked' : null })
  .on('change', function() { update() })

function resources() {
  var resources_txt = ""
  d3.select('#resources_selection')
  .selectAll('input')
  .each(function(d) {
    if (this.checked) 
      resources_txt += "," + this.value
  })
  return resources_txt === "" ? "" : resources_txt.substring(1)
}

function resources_array() { return resources().split(',') }

function show_advanced_mode() {
  d3.selectAll('tr.advancedmode').style('display', advanced_mode() ? '' : 'none')
  d3.selectAll('tr.simplemode').style('display', !advanced_mode() ? '' : 'none')

  if (getURLParameter('printer', 'false') === 'true') {
    d3.selectAll('tr').style('display', 'none')
  }
}

config['advanced_mode'] = (yaxismode()==='share' || yaxismode()==='total' || cc_vs() !== 'none') ? 'true' : 'false'

show_advanced_mode()

var margin = {top: 65, right: 75, bottom: 35, left: 30},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var color = d3.scale.ordinal()
color.range(["gray", "#187418", d3.rgb(254, 24, 24),"cyan","#36f",
"darkorange"
,"yellow","#960"])

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

var y = d3.scale.linear().range([height, 0])
var x = d3.time.scale().range([0, width])

var area = d3.svg.area()
    .x(function(d) { return x(d.year); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var stack = d3.layout.stack()
  .values(function(d) { return d.values; });

var countrycodes = {}

var all_data = null;

var pal = svg.append('g')
var pal2 = svg.append('g')

var info = svg.append("g")
  .attr("transform", "translate(20," + (20) + ")")

function selectSingle(root, id) {
    var sel = root.selectAll(id).data([1]);
    var t = {
        'enter' : function(fn) { fn(sel.enter()); return t },
        'update' : function(fn) { fn(sel); return t },
        'call' : function(fn) { sel.call(fn); return t },
        'selection' : function() { return sel },
        'text' : function(txt) { sel.text(txt); return t }
    }
    return t
}

function update() {
  var data = all_data.filter(function(d) { return d.country_code === cc() && d.year >= since() })
  while (data.length > 0) {
    var total = d3.sum(resources_array().map(function(res) { return data[0][res] }))
    if (total == 0) data.shift()
    else break
  }

  var minyear = d3.min(data.map(function(d) { return d.year }))
  var maxyear = d3.max(data.map(function(d) { return d.year }))
  var secondary_data = all_data.filter(function(d) { return d.country_code === cc_vs() && d.year >= minyear })
  var pas_data = all_data.filter(function(d) { return (d.country_code === cc() || d.country_code === cc_vs()) && d.year >= minyear })
  function countryname(cc, make_short) { 
    var name = countrycodes[cc].split(",")[0] 
    return make_short===false ? name : name.replace('South and Central', 'S. and C.')
  }
  var country_readable = countryname(data[0].country_code, false)

  color.domain(all_resources.split(","))

  var headingMinusY = -28

  var heading = selectSingle(svg, '#heading')
  .enter(function(sel) {
       sel.append('text')
      .attr('id', 'heading')
      .attr('class', 'heading')
      .attr('transform', 'translate(0, ' + headingMinusY + ')')
   })
   .update(function(sel) {
      sel.text(country_readable)
   })
   .selection()

  var vs = selectSingle(svg, '#vsCountryVsText')
  .enter(function(sel) { 
    sel.append('text')
    .attr('id', 'vsCountryVsText') 
    .attr('class', 'smallheading') 
    .attr('dx', '.31em')
  })
   .update(function(sel) {
    sel.attr('transform', 'translate(' + heading.node().getBBox().width + ','+headingMinusY+')')
   })
  .text(cc_vs() !== 'none' ? 'VS' : '')
  .selection()

  selectSingle(svg, '#vsCountryText')
  .enter(function(sel) { 
    sel.append('text')
    .attr('id', 'vsCountryText') 
    .attr('class', 'smallheading vsfill') 
    .style('font-weight', 'bold')
    .style('font-size', '19px')
    .attr('dx', '.45em')
  })
   .update(function(sel) {
    sel.attr('transform', 'translate(' + (vs.node().getBBox().width + heading.node().getBBox().width) + ','+headingMinusY+')')
   })
  .text(cc_vs() !== 'none' ? countryname(cc_vs(), true) : '')

  selectSingle(svg, '#yaxisInfo')
  .enter(function(sel) {
       sel.append('text')
      .attr('id', 'yaxisInfo')
      .attr('class', 'smallheading')
      .attr('dy', '-.71em')
   })
   .text(mode("Total Energy Consumption", "Per Capita Energy Consumption", "Relative share of energy consumption") + " " + minyear.getFullYear() + " - " + maxyear.getFullYear())

  function name(d) {
    return d.charAt(0).toUpperCase() + d.slice(1).replace('_', ' ');
  }

  var labelsLength = resources_array().length + (cc_vs()==='none' ? 0 : 1)
  var cc_vs_name = cc_vs()!=='none' ? [countryname(cc_vs(), true)] : []

  var infoheight = 8 + 16*(labelsLength)

  var fadedbox = selectSingle(info, '#fadedbox')
  .enter(function(sel) {
    sel
      .append('rect')
      .attr('id', 'fadedbox')
      .attr('class', 'fadedbox')
      .attr('width', 135)
  })
  .selection()
      .attr('height', infoheight)

  var pad = selectSingle(info, '#padding')
  .enter(function(sel) { sel.append('g').attr('id', 'padding').attr('transform', 'translate(7,0)') })
  .selection()

  var boxwidth = 20

  var resinfo = pad.selectAll('g.resourcelegend').data(resources_array(), function(d) { return d })
  
  var res_enter = resinfo.enter()
    .append('g')
    .attr('class', 'resourcelegend')

  resinfo.attr('transform', function(d, i) { return 'translate(0,' + (16*(resources_array().length-i)) + ')' })

  res_enter
    .append('rect')
    .attr('x', 0)
    .attr('y', -10)
    .attr('width', boxwidth)
    .attr('height', 12)
    .style('fill', color)
    .style('stroke', 'black')
    .style('stroke-opacity', '100%')

  res_enter
    .append('text')
    .attr('transform', 'translate(' + (boxwidth + 4) + ',0)')
    .text(name)
  resinfo.exit().remove()

  var sel = pad.selectAll('g.vs_legend').data(cc_vs_name)
  var entercontext = sel.enter()
   .append('g')
   .attr('class', 'vs_legend')
  entercontext
   .append('text')
    .attr('transform', 'translate(' + (boxwidth + 4) + ',0)')
    .attr('class', 'vsfill')
    .style('font-weight', 'bold')
  sel.attr('transform', 'translate(0,' + (16*(resources_array().length+1)) + ')')

  entercontext
   .append('line')
   .attr('class', 'line')
   .attr('x1', 0)
   .attr('x2', boxwidth)
   .attr('y1', -10 + 6)
   .attr('y2', -10 + 6)

  entercontext
   .append('circle')
   .attr('class', 'cmpdot vsfill')
   .attr('cx', boxwidth/2)
   .attr('cy', -10 + 6)
   .attr('r', 3.5)
  sel.select('text').text(Object)
  sel.exit().remove()

  var node = sel.select('text').node()
  var vsTextWidth = 15 + boxwidth + (node != null ? node.getBBox().width : 0)
  fadedbox.attr('width', d3.max([135, vsTextWidth]))

  function total_value(d) {
    var p = mode(1.0, (d.population / 1000000.0))
    var val = d3.sum(resources_array().map(function(res) { return d[res] }))
    return val / p
  } 

  var maxy = d3.max(pas_data.map(total_value))
  y.domain([0, mode(maxy, maxy, 100.0)])
  x.domain(d3.extent(data.map(function(d) { return d.year })))

  var cmp_line = secondary_data.map(function(d) { return {x : d.year, y : total_value(d)} })

  var resource_stack = stack(resources_array().map(function(resource) {
    return {
      name: resource,
      values: data.map(function(d) { 
      var total = d3.sum(resources_array().map(function(res) { return d[res] }))
      var p = mode(1.0, (d.population / 1000000.0), total)
      return { year: d.year, y: p==0 ? 0 : (mode(1.0, 1.0, 100.0)*d[resource])/p }
      })
  }}))

  selectSingle(svg, '#yAxisLabel')
    .enter(function(sel) { 
      sel.append('text')
      .attr('id', 'yAxisLabel')
      .style('text-anchor', 'middle')
      .attr('transform', 'translate(' + width + ',0)')
      .attr('dy', '-.71em')
      //.attr('dx', '2.01em')
      })
    .text(mode('MTOE/a', 'TOE/Capita/a', 'Percentage'))

  selectSingle(svg, '.x.axis')
  .enter(function(sel) {
    sel.append('g')
    .attr('class', 'x axis')
    .attr("transform", "translate(0," + height + ")")
  })
  .call(d3.svg.axis().scale(x).orient("bottom"))

  selectSingle(pal, '.y.axis')
  .enter(function(sel) {
    sel.append('g')
    .attr('class', 'y axis')
    .attr("transform", "translate(" + width + ",0)")
  })
  .call(d3.svg.axis().scale(y).orient("right"))

  var energy = pal.selectAll(".energy") .data(resource_stack)
  energy.enter().append("g")
  .attr("class", "energy")
  .append("path")
  .attr("class", "area")

  energy.select('path')
  .attr("d", function(d) { return area(d.values); })
  .style("fill", function(d) { return color(d.name); });

  energy.exit().remove()

  selectSingle(pal2, '#cmpLine')
  .enter(function(sel) {
    sel.append('path')
    .attr('id', 'cmpLine')
    .attr('class', 'line')
  })
  .selection()
  .datum(cmp_line)
  .attr('d', 
    d3.svg.line(cmp_line)
    .x(function(d) { return x(d.x) })
    .y(function(d) { return y(d.y) })
  )

  var sel = selectSingle(pal2, '#cmpdots')
  .enter(function(sel) {
    sel.append('g')
    .attr('id', 'cmpdots')
  })
  .selection()

  sel = sel.selectAll('circle').data(cmp_line)
  sel.enter().append('circle')
  sel
    .attr('class', 'vsfill cmpdot')
    //.style('fill', 'vsfill cmpdot')
    .attr('cx', function(d) { return x(d.x) })
    .attr('cy', function(d) { return y(d.y) })
    .attr('r', 3.5)
  sel.exit().remove()

  selectSingle(svg, '#unitExplanation')
  .enter(function(sel) { 
    sel
    .append('text')
    .attr('id', 'unitExplanation') 
    .attr('transform', 'translate('+ (width+margin.right) +',' + (height/2) + ') rotate(90)') 
    .attr('dy', '1.51em')
    .attr('text-anchor', 'middle')
  })
  .text(mode('Million Tonnes Oil Equivalents per annum',
             'Tonnes Oil Equivalents per Capita per annum',
             'Relative share of energy consumption'))

  var permlink = window.location.href.split('?')[0] + '?country_code=' + cc()
  permlink += (cc_vs() !== 'none') ? ('&country_code_vs=' + cc_vs()) : ''
  permlink += (yaxismode() !== 'per_capita') ? ('&mode=' + yaxismode()) : ''

  if (resources_array().length != all_resources.split(",").length) {
    permlink += "&resources=" + resources()
  }

  d3.select('#permalink')
  .attr('href', permlink)
  d3.select('#permalink_printer')
  .attr('href', permlink + "&printer=true")
}

d3.tsv('data/data.tsv', function(err, data) {
  data.forEach(function(d) { countrycodes[d.country_code] = d.country })
  var ccs = d3.set(data.map(function(d) { return d.country_code }))
  var codes = ccs.values().filter(function(d) { return d3.keys(countrycodes).indexOf(d) != -1 })
  var rev = {}
  codes.forEach(function(d) { return rev[countrycodes[d]] = d } )

  var names = d3.keys(rev)
  names.sort()

  names.forEach(function(d) {
    var code = rev[d]
    var id = code.indexOf('BP_') == 0 ? "#groups" : "#countries"
    var option = d3.select(id)
      .append('option')
      .attr('value', rev[d])
      .text(d)

    var sel = d3.select(id + "_vs")
      .append('option')
      .attr('value', rev[d])
      .text(d)
    if (cc_vs() === code)
      sel.attr('selected', 'selected')

    if (cc() == code)
      option.attr('selected', 'selected')
  })

  data.forEach(function(d) {
    d.year = format.parse(d.year)
    d.population = +d.population
    d.coal = +d.coal
    d.gas = +d.gas
    d.hydro = +d.hydro
    d.nuclear = +d.nuclear
    d.oil = +d.oil
    d.other_renewables = +d.other_renewables
    d.solar = +d.solar
    d.wind = +d.wind
  })

  all_data = data
  update()

  selectSingle(svg, '#contact')
  .enter(function(sel) { 
    sel
    .append('text')
    .attr('id', 'contact') 
    .attr('transform', 'translate(' + (width+margin.right) + ',' + (height+margin.bottom) + ')') 
    .attr('dx', '-.21em')
    .attr('dy', '-.31em')
    .style('text-anchor', 'end')
  })
  .text('Diagram by refsdal.ivar@gmail.com')

  selectSingle(svg, '#sources')
  .enter(function(sel) { 
    sel
    .append('text')
    .attr('id', 'sources') 
    .attr('transform', 'translate(' + (-margin.left) + ',' + (height+margin.bottom) + ')') 
    .attr('dx', '.21em')
    .attr('dy', '-.31em')
    .style('text-anchor', 'start')
  })
  .text('Data from BP Statistical Review and World Bank')
})

function showAdvancedMode() { config['advanced_mode'] = 'true'; show_advanced_mode() }
function hideAdvancedMode() { config['advanced_mode'] = 'false'; show_advanced_mode() }
</script>
</body>
