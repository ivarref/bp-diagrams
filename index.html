<!DOCTYPE html>
<meta charset="utf-8">
<style>
body { font: 12px sans-serif; }
svg { border: 1px solid #000; }
text.heading { font: 22px sans-serif; font-variant: small-caps; font-weight: bold; }
text.smallheading { font: 14px sans-serif; }
.cc { fill: mediumblue; }
.population { fill: mediumblue; }
.cc_vs { fill: Fuchsia; /* c0f */ }
.cmpdot { stroke: black; stroke-width: 1.0px; }
.fadedbox { fill: #fff; fill-opacity: 87%; stroke: black; }
.line { fill: none; stroke: black; stroke-width: 3.0px; }
.export { fill: blue; }
.import { fill: red; }
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
rect { shape-rendering: crispEdges; }
tr.advancedmode { }
tr.simpledmode { }
</style>
<title>Energy Consumption</title>
<body>
<form style='padding-bottom: 2px;'>
<table>
  <tr>
    <td>Choose country or group of nations: </td>
    <td>
      <select id='ccselect' name='cc' style='min-width: 222px;'>
        <optgroup id='groups' label="Group of nations"></optgroup>
        <optgroup id='countries' label="Country"></optgroup>
      </select>
    </td>
  </tr>
  <tr class="simplemode">
    <td colspan="2">
      <a href="#" onclick="show_advanced_mode('true'); return false;">Show more options</a>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose reference country or group: </td>
    <td>
      <select id='ccselect_vs' name='vs_cc' style='min-width: 222px;'>
        <optgroup id='groups_vs' label="Group of nations">
          <option value='none'>None</option>
        </optgroup>
        <optgroup id='countries_vs' label="Country"></optgroup>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose what to show:</td>
    <td>
      <select id='mode_select' name='' style='min-width: 222px;'>
        <optgroup label="Consumption">
          <option value="per_capita">Per capita energy consumption</option>
          <option value="total">Total energy consumption</option>
          <option value="share">Relative share of energy consumption</option>
        </optgroup>
        <optgroup label="Production">
          <option value="per_capita_prod">Per capita energy production</option>
          <option value="total_prod">Total energy production</option>
          <option value="share_prod">Relative share of energy production</option>
        </optgroup>
        <optgroup label="Net Import / Export">
          <option value="per_capita_net">Per capita net energy Import / Export</option>
          <option value="total_net">Total net energy Import / Export</option>
        </optgroup>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Show numbers for year:</td>
    <td>
      <select id='show_numbers' name='show_numbers' style='min-width: 222px;'>
        <option value='none' selected="selected">None</option>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose resources to include:</td>
    <td id="resources_selection">
      <label><input type="checkbox" name="resources" value="coal" checked="checked">Coal</input></label>
      <label><input type="checkbox" name="resources" value="oil" checked="checked">Oil</input></label>
      <label><input type="checkbox" name="resources" value="gas" checked="checked">Gas</input></label>
      <label><input type="checkbox" name="resources" value="nuclear" checked="checked">Nuclear</input></label>
      <label><input type="checkbox" name="resources" value="hydro" checked="checked">Hydro</input></label>
      <label><input type="checkbox" name="resources" value="other_renewables" checked="checked">Other renewables</input></label>
      <!--label><input type="checkbox" name="resources" value="solar" checked="checked">Solar</input></label>
      <label><input type="checkbox" name="resources" value="wind" checked="checked">Wind</input></label-->
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td>Choose extra left Y-axis:</td>
    <td>
      <select id='left_y_axis' name='left_y_axis' style='min-width: 222px;'>
        <!--<option value='none' selected="selected">None</option>-->
        <option value='same' selected="selected">Same as right y axis</option>
        <option value='percentage'>Percentage of all time high</option>
        <option value='population'>Population</option>
        <option value='gdp_capita'>GDP per Capita</option>
      </select>
    </td>
  </tr>
  <tr class="advancedmode" style="display: none">
    <td><a href="#" onclick="show_advanced_mode('false'); return false;">Hide extra options</a></td>
    <td><a href="#" id="permalink">Permalink to this diagram</a> <a href="#" id="permalink_printer">printer friendly</a></td>
  </tr>
</table>
</form>
<script src="d3.v3.min.js"></script>
<script>
  if (window.location.href.indexOf("localhost") == -1) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56575481-1', 'auto');
    ga('send', 'pageview');
  }

  function sign(x) { return x==0 ? 0 : (x>=0 ? 1 : -1) }

function contains() { 
  var list = []
  for (var i = 0; i < arguments.length; i++) {
    var argument = arguments[i]
    if (typeof argument === 'string') {
      list.push(argument)
    }
    else if ('push' in argument) {
      list = list.concat(argument)
    }
  }
  return function(d) { return list.indexOf(d) >= 0 } 
}

function not_contains() { var fn = contains.apply(null, arguments); return function(d) { return !fn(d) } }

/*
http://www.w3schools.com/tags/ref_color_tryit.asp?color=white
*/
var format = d3.time.format("%Y")
var config = {}
//var all_resources = "coal,oil,gas,nuclear,hydro,other_renewables,solar,wind"
var all_resources = "coal,oil,gas,nuclear,hydro,other_renewables"

function getURLParameter(name, default_value) {
  var component = decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))
  return (name in config) ? config[name] : (component||default_value).split('/')[0]
}

var config_cache = {} // hmmm....

function cached(name, get_value_fn) {
  return function() {
      if (name in config_cache) {
        return config_cache[name]
      }
      else {
        var val = get_value_fn()
        config_cache[name] = val
        return val
      }
  }
}

function clear_cache() {
  for (var key in config_cache) {
    delete config_cache[key]
  }
}

function yaxismode() { return getURLParameter('mode', 'per_capita') }
function advanced_mode() { return getURLParameter('advanced_mode', 'false') === 'true'; }
var cc = cached('cc', function() { return getURLParameter('country_code', 'BP_WORLD') })


function is_share_mode() { return yaxismode().indexOf('share') >= 0 }
function is_net_mode() { return yaxismode().indexOf('_net') >= 0 }

var cc_vs = cached('cc_vs', function() { 
  var ccvs = getURLParameter('country_code_vs', 'none'); 
  return (is_share_mode() || (!is_net_mode() && ccvs === cc())) ? 'none' : ccvs
  //return (is_share_mode()) ? 'none' : ccvs
})

function is_cc_vs() { return cc_vs() !== 'none' }

function show_numbers() { return config['show_numbers'] }
function is_show_numbers() { return show_numbers() !== 'none' }
config['show_numbers'] = getURLParameter('numbers', 'none')

function update_show_numbers(data) {
  var sel = d3.select('#show_numbers')
  .selectAll('option').data(['none'].concat(data.map(function(d) { return "" + d.year.getFullYear() }).reverse()), function(d) { return d; })
  sel.enter().append('option')

  sel.attr('value', Object)
  sel.attr('selected', function(d) { return d === show_numbers() ? 'selected' : null })
  sel.text(function(d) { return d.charAt(0).toUpperCase() + d.slice(1) } )
  sel.exit().remove()
}

function set_selected(attr, from_id) {
  return function() {
    var sel = document.getElementById(from_id)
    var selected = sel.options[sel.selectedIndex].value
    config[attr] = selected
    update()
  }
}

d3.select('#show_numbers').on('change', set_selected('show_numbers', 'show_numbers'))
d3.select('#ccselect').on('change', set_selected('country_code', 'ccselect'))
d3.select('#ccselect_vs').on('change', set_selected('country_code_vs', 'ccselect_vs'))
d3.select('#left_y_axis').on('change', set_selected('left_y_axis', 'left_y_axis'))
  .selectAll('option').filter(function(d) { return this.value === left_y_axis() })
  .attr('selected', 'selected')

d3.select('#mode_select').on('change', set_selected('mode', 'mode_select'))
  .selectAll('option')
  .filter(function(d) { return this.value === yaxismode() })
  .attr('selected', 'selected')

d3.select('#resources_selection')
  .selectAll('input')
  .attr('checked', function(d) { return (getURLParameter('resources', all_resources).split(",").indexOf(this.value) != -1) ? 'checked' : null })
  .on('change', function() { update() })

function resources() {
  var resources_txt = ""
  var postfix = majormode({'consumption' : "", 'production' : "_production", 'net' : "_net"})
  d3.select('#resources_selection')
  .selectAll('input')
  .each(function(d) {
    if (this.checked && this.disabled == false)
      resources_txt += "," + this.value + postfix
  })
  return resources_txt === "" ? "" : resources_txt.substring(1)
}
function resources_array() { return resources().split(',') }

function has_resource(res) {
  var rr = res.split(",")
  var ress = resources_array()
  for (var i=0; i<rr.length; i++) {
    if (ress.indexOf(rr[i]) >= 0)
      return true
  }
  return false
}

function since() { 
  var default_since_year = d3.max(['1965',
                                    has_resource('gas_production,gas_net')  ? '1970' : '0',
                                    has_resource('coal_production,coal_net') ? '1981' : '0'])
  return format.parse(getURLParameter('since', default_since_year))
}

function left_y_axis() { 
  var val = getURLParameter('left_y_axis', 'same') 
  if ((val === 'percentage') && is_net_mode()) {
    val = 'same'
  }
  return val
}

function show_advanced_mode(hideOrShow) {
  config['advanced_mode'] = hideOrShow
  d3.selectAll('tr.advancedmode').style('display', advanced_mode() ? '' : 'none')
  d3.selectAll('tr.simplemode').style('display', !advanced_mode() ? '' : 'none')

  if (getURLParameter('printer', 'false') === 'true') {
    d3.selectAll('tr').style('display', 'none')
  }
}
var advanced_bool = is_show_numbers() || is_net_mode() || is_share_mode() || (yaxismode()==='total') || is_cc_vs() || (left_y_axis() != 'same')
config['advanced_mode'] = advanced_bool ? 'true' : 'false'

show_advanced_mode(config['advanced_mode'])

var margin = {top: 65, right: 75, bottom: 35, left: 75},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var color = d3.scale.ordinal()
color.range([
"gray", "gray", "gray",
"#187418", "#187418", "#187418", 
d3.rgb(254, 24, 24), d3.rgb(254, 24, 24), d3.rgb(254, 24, 24),
"cyan","#36f"
,"darkorange"
,"yellow"
,"#960"])
color.domain("coal,coal_production,coal_net,oil,oil_production,oil_net,gas,gas_production,gas_net,nuclear,hydro,other_renewables".split(","))

var svg = d3.select("body").append("svg")
    .attr("xmlns", "http://www.w3.org/2000/svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

var y = d3.scale.linear().range([height, 0])
var x = d3.time.scale().range([0, width])

var area = d3.svg.area()
    .x(function(d) { return x(d.year) })
    .y0(function(d) { return y(d.y0) })
    .y1(function(d) { return y(d.y0 + d.y) })

var stack = d3.layout.stack().values(function(d) { return d.values; })

var countrycodes = {}

var all_data = null;

var pal = svg.append('g')
var pal2 = svg.append('g')

var info = svg.append("g")
  .attr("transform", "translate(20," + (20) + ")")

function singleElement(root, elementtype, id) {
  var sel = root.selectAll(elementtype + "#" + id).data([1])
  sel.enter().append(elementtype).attr('id', id)
  return sel
}

function selectionMap(sel, fn) {
  var result = []
  sel.each(function(d) { result.push(fn(this, d)) })
  return result
}

function countryname(cc, make_short) { 
  var name = countrycodes[cc].split(",")[0] 
  return make_short===false ? name : name.replace('South and Central', 'S. and C.')
}

function countryname_total(cc) {
  var name = countryname(cc, true)
  return (name.indexOf('Total') == 0 ? name.split("Total ")[1] : name) + " total"
}

function resource_name(d) {
  d = d.split('_net')[0].split("_production")[0]
  var n = d.charAt(0).toUpperCase() + d.slice(1).replace('_', ' ');
  return n
}

function graph_add_heading_and_subheading() {
  var headingMinusY = -28

  var showVs = is_cc_vs() ? (cc()!==cc_vs()) : false; //(is_net_mode() && is_cc_vs()) ? (cc()!==cc_vs()) : is_cc_vs()

  var heading = singleElement(svg, 'text', 'heading')
  .attr('class', 'heading cc')
  .attr('transform', 'translate(0, ' + headingMinusY + ')')
  .text(countryname(cc(), false))

  var vs = singleElement(svg, 'text', 'vstext')
  .attr('class', 'smallheading') 
  .attr('dx', '.35em')
  .attr('transform', 'translate(' + heading.node().getBBox().width + ','+headingMinusY+')')
  .text(showVs ? 'VS' : '')

  singleElement(svg, 'text', 'vscountrytext')
  .attr('class', 'heading cc_vs') 
  .attr('dx', '.43em')
  .attr('transform', 'translate(' + (vs.node().getBBox().width + heading.node().getBBox().width) + ','+headingMinusY+')')
  .text(showVs ? countryname(cc_vs(), true) : '')
}

function y_unit_text() {
  return yaxismodemap({'total' : 'MTOE/a', 'per_capita' : 'TOE/Capita/a', 'share' : 'Percentage' })
}

function yaxismodemap(map) {
  var themode = yaxismode()
  var res = map[themode.split("_prod")[0].split("_net")[0]]
  if (res  === undefined) {
    console.trace()
    throw 'ERROR. Undefined mode: ' + yaxismode()
  }
  return res
}

function majormode(map) {
  var key = "per_capita,total,share".split(",").indexOf(yaxismode()) >= 0 ? "consumption" : null
  if (yaxismode().indexOf('_prod') >= 0)
    key = "production"
  if (yaxismode().indexOf('_net') >= 0)
    key = "net"

  if (!(key in map)) {
    console.trace()
    throw 'ERROR. Missing key: ' + key
  }
  return map[key]
}

function total_value_positive(d) {
  var sum = d3.sum(resources_array().map(function(res) { return d[res] >=0 ? d[res] : 0 }))
  return yaxismodemap({
         'per_capita' : function() { return sum / (d.population / 1000000.0) }
         ,'share' : function() { return 100.0 }
         ,'total' : function() { return sum }
         })()
} 

function total_value_negative(d) {
  var sum = d3.sum(resources_array().map(function(res) { return d[res] <=0 ? d[res] : 0 }))
  return yaxismodemap({
         'per_capita' : function() { return sum / (d.population / 1000000.0) }
         ,'share' : function() { return 100.0 }
         ,'total' : function() { return sum }
         })()
} 

function total_value(d) {
  var sum = d3.sum(resources_array().map(function(res) { return d[res] }))
  return yaxismodemap({
         'per_capita' : function() { return sum / (d.population / 1000000.0) }
         ,'share' : function() { return 100.0 }
         ,'total' : function() { return sum }
         })()
} 

function resource_fn() {
  return yaxismodemap({
         'per_capita' : function(d, res) { return d[res] / (d.population / 1000000.0) }
         ,'share' : function(d, res) { return (100.0 * d[res]) / d3.sum(resources_array().map(function(rr) { return d[rr] })) }
         ,'total' : function(d, res) { return d[res] }
         })
}

function graph_add_resources_info_box(data, secondary_data) {
  var box = {width:20, height: 14, padding:4}
  var padding = {left: 7, top: 7}

  var res = resources_array().reverse()
  var translate = { }
  var skipCCname = is_cc_vs() && cc() === cc_vs() && is_net_mode()
  if (is_show_numbers()) {
    res.unshift('heading')

    if (!is_share_mode() && !skipCCname) {
      res.push('cc')
    }
    translate.heading = 'Resource' + (is_share_mode() ? '' : ' / Country')
    translate.cc = countryname_total(cc())
  }
  if (is_cc_vs()) {
    res.push('cc_vs')
    translate.cc_vs = countryname_total(cc_vs())
  }
  resources_array().forEach(function(res) { translate[res] = resource_name(res) })

  if (left_y_axis() != 'same' && left_y_axis() != 'percentage') {
    res.push(left_y_axis())
    translate.population = countryname(cc(), true) + ' population'
    translate.gdp_capita = is_cc_vs() ? (countryname(cc(), true) + ' GDP/Capita') : 'GDP/Capita'
  }

  var infoheight = (padding.top) + (padding.top-box.padding) + (box.height+box.padding)*(res.length)

  /* faded background box */
  var fadedbox = singleElement(info, 'rect', 'fadedbox')
  .attr('class', 'fadedbox')
  .attr('width', 135)
  .attr('height', infoheight)

  var boundary = singleElement(info, 'g', 'boundary')
    .attr('transform', 'translate(' + padding.left + ',' + padding.top + ')')
  var infobox = singleElement(boundary, 'g', 'infobox_left')

  /* boxes and names of resource */
  var resinfo = infobox.selectAll('g.resourcelegend').data(res, function(d) { return d })
  var res_enter = resinfo.enter().append('g').attr('class', 'resourcelegend')
  resinfo.attr('transform', function(d, i) { return 'translate(0,' + (box.height + box.padding)*i + ')' })

  /* enter */
  res_enter
    .filter(contains(resources_array()))
    .append('rect')
    .attr('width', box.width)
    .attr('height', box.height)
    .style('fill', color)
    .style('stroke', 'black')
    .style('stroke-opacity', '1.0')

  var h = (box.height) / resources_array().length

  res_enter
    .filter(contains('cc'))
    .append('g')

  var cc_box = resinfo.select('g')
    .selectAll('rect').data(resources_array().reverse(), function(d) { return d })
  cc_box.enter().append('rect')
    .attr('width', box.width)

  cc_box
    .attr('height', h)
    .attr('y', function(d, i) { return i*h })
    .attr('x', 0)
    .style('fill', color)
    .style('stroke', 'none')

  cc_box.exit().remove()

  res_enter
    .filter(contains('cc'))
    .append('rect')
    .attr('width', box.width)
    .attr('height', box.height)
    .style('fill', 'none')
    .style('stroke', 'black')
    .style('stroke-opacity', '1.0')
    .style('stroke-width', '1px')

  res_enter
    .append('text')
    .attr('y', box.height/2 + .5)
    .attr('dy', '.355em')
    .attr('transform', function(d) { return d === 'heading' ? null : 'translate(' + (box.width + 4) + ',0)' })
    .filter(not_contains(resources_array()))
    .style('font-weight', 'bold')
    .filter(contains('cc', 'cc_vs', 'population', 'gdp_capita'))
    .attr('class', Object)

  res_enter
   .filter(contains('cc_vs', 'population', 'gdp_capita'))
   .append('line')
   .attr('class', 'line')
   .attr('x1', 0)
   .attr('x2', box.width)
   .attr('y1', (box.height/2))
   .attr('y2', (box.height/2))

  res_enter
   .filter(contains('cc_vs'))
   .append('circle')
   .attr('class', 'cmpdot cc_vs')
   .attr('cx', box.width/2)
   .attr('cy', box.height/2)
   .attr('r', 3.5)

  res_enter
   .filter(contains('population', 'gdp_capita'))
   .append('rect')
   .attr('class', 'cmpdot cc_vs')
   .attr('transform', 'translate(' + (box.width/2) + ',' + (box.height/2) + ') rotate(45)')
   .attr('x', -3)
   .attr('y', -3)
   .attr('width', 6)
   .attr('height', 6)
   .style('fill', 'yellow')
   .style('stroke-width', '1.5px')

  /* update */
  resinfo.select('text').text(function(d) { return translate[d] })

  /* exit */
  resinfo.exit().remove()

  var width_left = 2*padding.left + 4 + box.width + d3.max(selectionMap(infobox.selectAll('text'), function(node, d) { return node.getBBox().width }))

  /* Actual numbers and heading */
  var margin_left = 90
  var right_x = width_left + margin_left

  var dat = {}
  var decimals = yaxismodemap({ per_capita : 2, total : 1, share : 1})

  res = is_show_numbers() ? res : []

  if (is_show_numbers()) {
    data = data.filter(function(d) { return d.year.getFullYear()+"" == show_numbers() })[0]
    var fn = resource_fn()
    resources_array().forEach(function(res) { 
      dat[res] = fn(data, res).toFixed(decimals)
    })

    secondary_data = secondary_data.filter(function(d) { return d.year.getFullYear()+"" == show_numbers() })
    dat.heading = y_unit_text() + ' (' + show_numbers() + ')'
    dat.cc = total_value(data).toFixed(decimals)
    dat.cc_vs = is_cc_vs() ? total_value(secondary_data[0]).toFixed(decimals) : null
  }

  var infobox_right = singleElement(boundary, 'g', 'infobox_right')

  function add_numbers(sel) {
    sel.enter().append('text')
    sel
    .style('text-anchor', 'end')
    .attr('x', right_x)
    .attr('y', box.height/2)
    .attr('dy', '.35em')
    .attr('transform', function(d, i) { return 'translate(0,' + (box.height + box.padding)*(i) + ')' })
    .text(function(d) { return dat[d] })
    .filter(not_contains(resources_array()))
    .style('font-weight', 'bold')
    .filter(contains('cc', 'cc_vs'))
    .attr('class', Object)
    sel
    .filter(contains(resources_array()))
    .attr('class', 'cc')

    sel.filter(function(d, i) { return i>0 && is_net_mode() && (+dat[d])>=0 }).attr('class', 'export')
    sel.filter(function(d, i) { return i>0 && is_net_mode() && (+dat[d])<0 }).attr('class', 'import')

    sel.exit().remove()
  }
  infobox_right.selectAll('text').data(res, function(d) { return d }).call(add_numbers)

  var width_right = 2*padding.left + d3.max([0].concat(selectionMap(infobox_right.selectAll('text'), function(node, d) { return node.getBBox().width })))
  
  fadedbox.attr('width', width_left + (res.length==0 ? 0 : margin_left+15))
}

function show_subheading(minyear, maxyear) {
  var headingTxt = yaxismodemap({'per_capita' : "Per Capita Energy", "total" : "Total Energy", "share" : "Relative Share of Energy"})
  + " " + majormode({production : 'Production', consumption : 'Consumption', net : 'Net'}) //Import / Export'})
  graph_add_heading_and_subheading()

  var txts = []

  function w() {
    var tt = txts.filter(function(d) { return d.text().length > 0})
    return 5*tt.length + d3.sum(tt.map(function(d) { return d.node().getBBox().width }))
  }

  txts.push( singleElement(svg, 'text', 'subheadingtext')
  .attr('class', 'smallheading')
  .attr('dy', '-.71em')
  .text(headingTxt))

  txts.push(singleElement(svg, 'text', 'subheadingtext_import').attr('dy', '-.71em')
  .attr('transform', 'translate(' + w() + ',0)')
  .style('font-weight', 'bold')
  .attr('class', 'smallheading import')
  .text(is_net_mode() ? 'Import' : ''))

  txts.push(singleElement(svg, 'text', 'subheadingtext_slash').attr('class', 'smallheading').attr('dy', '-.71em')
  .attr('transform', 'translate(' + w() + ',0)')
  .text(is_net_mode() ? '/' : ''))

  txts.push(singleElement(svg, 'text', 'subheadingtext_export').attr('dy', '-.71em')
  .attr('transform', 'translate(' + w() + ',0)')
  .style('font-weight', 'bold')
  .attr('class', 'smallheading export')
  .text(is_net_mode() ? 'Export' : ''))

  txts.push(singleElement(svg, 'text', 'subheadingtext_years').attr('class', 'smallheading').attr('dy', '-.71em')
  .attr('transform', 'translate(' + w() + ',0)')
  .text(minyear + ' - ' + maxyear))

}

function update() {
  clear_cache()
  d3.select('#ccselect_vs')
  .attr('disabled', function() { return is_share_mode() ? 'disabled' : null })

  d3.select('#resources_selection')
  .selectAll('input')
  .attr('disabled', function() {
    if (majormode({'consumption' : true, 'production' : false, net : false}))
      return null
    else 
      return 'oil,coal,gas'.indexOf(this.value) >= 0 ? null : "disabled"
  })

  var filter_net_mode = function(d) { return is_net_mode() ? true : !('prop_change' in d) }

  var data = all_data.filter(function(d) { return filter_net_mode(d) && d.country_code === cc() && d.year >= since() })
  var minyear = d3.min(data.map(function(d) { return d.year }))
  var maxyear = d3.max(data.map(function(d) { return d.year }))
  var secondary_data = all_data.filter(function(d) { return filter_net_mode(d) && d.country_code === cc_vs() && d.year >= minyear })
  var pas_data = all_data.filter(function(d) { return filter_net_mode(d) && (d.country_code === cc() || d.country_code === cc_vs()) && d.year >= minyear })
  var country_readable = countryname(data[0].country_code, false)

  update_show_numbers(data)

  show_subheading(minyear.getFullYear(), maxyear.getFullYear())

  graph_add_resources_info_box(data, secondary_data)

  var maxy = d3.max(pas_data.map(total_value_positive))
  var miny = d3.min(pas_data.map(total_value_negative))
  y.domain([d3.min([miny, 0]), d3.max([0, maxy])])
  x.domain(d3.extent(data.map(function(d) { return d.year })))

  var cmp_line = secondary_data.filter(function(d) { return !('prop_change' in d) }).map(function(d) { return {x : d.year, y : total_value(d)} })
  var left_y_fn = {
                   'none' : function() { return 0; },
                   'percentage' : function() { return 0; },
                   'population' : function(d) { return d.population / 1000000.0; },
                   'gdp_capita' : function(d) { return d.gdp / d.population; },
                   'same' : function(d) { return total_value(d) }
                   }[left_y_axis()];

  var filt = function(d) { return true; }
  if (left_y_axis() ==='gdp_capita') {
    filt = function(d) { return !isNaN(d.gdp) }
  }

  var pop_line = data.filter(function(d) { return !('prop_change' in d) }).filter(filt).map(function(d) { return {x : d.year, y : left_y_fn(d) } })

  var y0neg = {}
  var y0pos = {}
  var resource_stack = []
  resources_array().forEach(function(resource) {
    var grouped = []
    var val = function(d) {
      var vv = yaxismodemap({
        'per_capita' : function() { return d[resource] / (d.population / 1000000.0) }
        ,'total' : function() { return d[resource] }
        ,'share' : function() { 
          var sum = d3.sum(resources_array().map(function(res) { return d[res] }))
          return sum == 0 ? 0 : (100.0 * (d[resource] / sum))
        }})()
      if (vv === undefined) {
        console.log('could not make value for ' + resource)
        console.log('DATA:')
        console.log(d)
        console.log('End of DATA')
        throw 'Error'
      }
      return vv
    }

    var build_point = function(d, curr_sign) {
      var k = d.year.getTime()
      if (!(k in y0neg)) y0neg[k] = 0
      if (!(k in y0pos)) y0pos[k] = 0
      var y = val(d)
      var y0 = (curr_sign >= 0) ? y0pos[k] : y0neg[k]
      if (curr_sign == 1) y0pos[k] += y
      else y0neg[k] += y
      return { year: d.year, y0: y0, y: y }
    }

    // TODO clean up this filtering...
    var filtered = []
    function is_zero(v) { return val(v) == 0 }
    var vv = data.map(val)
    //console.log(vv)

    for (var i=0; i<data.length; i++) {
      var c = data[i]
      if (i>=1) {
        var p =data[i-1]
        //if (p.year.getTime() == c.year.getTime() && val(c) == val(p)) continue
      }
      filtered.push(c)
    }
    // Remove leading zeros
    while (filtered.length >= 2 && is_zero(filtered[0]) && is_zero(filtered[1]))
      filtered.shift()

    // Remove trailing zeros
    while (filtered.length >= 2 && is_zero(filtered[filtered.length-1]) && is_zero(filtered[filtered.length-2])) {
      //console.log('pop ' + (filtered.length-1))
      filtered.pop()
    }

    if (filtered.length == 1 && is_zero(filtered[0])) {
      filtered.pop()
    }

    var last_sign = null
    filtered.forEach(function(d, i) {
      var curr_val = val(d)
      var prev_data = filtered[(i==0) ? i : i-1]
      var prev_val = val(prev_data)

      var curr_sign = sign(curr_val)
      curr_sign = curr_sign == 0 ? sign(prev_val) : curr_sign
      if (sign(curr_val) == 0 && sign(prev_val) ==0 && i>=1) return
      if (curr_sign == 0 && i==0) curr_sign = val(filtered[i+1])
      if (curr_sign == 0) {
        console.log(filtered)
        console.log("i = " + i)
        console.log(resource)
        console.log(d.year)
        throw 'Im sorry.'
      }

      if (sign(curr_val) != sign(prev_val) && sign(prev_val)==0) {
        //console.log('change of sign at ' + i + ' for ' + resource + ' curr sign is ' + sign(curr_val))
        resource_stack.push({name : resource, sg: last_sign, values: grouped})
        //console.log(grouped.length)
        grouped = [build_point(prev_data, curr_sign)]
      }
      grouped.push(build_point(d, curr_sign))
      last_sign = curr_sign
    })
    resource_stack.push({name: resource, sg: last_sign, values: grouped})
  })

  singleElement(svg, 'text', 'yAxisLabel')
  .style('text-anchor', 'middle')
  .attr('transform', 'translate(' + width + ',0)')
  .attr('dy', '-.71em')
  .text(yaxismodemap({'total' : 'MTOE/a', 'per_capita' : 'TOE/Capita/a', 'share' : 'Percentage'}))

  singleElement(pal2, 'line', 'divider_line')
  .attr('transform', 'translate(0,' + (y(0)) + ')')
  .attr('x1', 0)
  .attr('y1', 0)
  .attr('x2', width)
  .attr('y2', 0)
  .style('stroke', function(d) { return is_net_mode() ? 'black' : null })

  singleElement(svg, 'g', 'xAxis')
  .attr('class', 'x axis')
  .attr("transform", "translate(0," + height + ")")
  .call(d3.svg.axis().scale(x).orient("bottom"))

  singleElement(pal, 'g', 'yAxis')
  .attr('class', 'y axis')
  .attr("transform", "translate(" + width + ",0)")
  .call(d3.svg.axis().scale(y).orient("right"))
  .selectAll('text')
  .attr('class', function(d) { return (!is_net_mode() || parseFloat(d3.select(this).text()) == 0.0)  ? null : d3.select(this).text().indexOf('-') == 0 ? 'import' : 'export' })

  var energy = pal.selectAll(".energy").data(resource_stack)
  energy.enter().append("g")
  .attr("class", "energy")
  .append("path")
  .attr("class", "area")
  energy.select('path')
  .attr("d", function(d) { return area(d.values) })
  .style("fill", function(d) { return color(d.name) })
  .style("fill-opacity", function(d) { return (d.sg>=0 ? null : '65%') })
  //.on('mouseover', function(d) { d3.select(this).style('fill-opacity', '50%') .style('stroke', 'black') .style('stroke-width', '5px') })
  //.on('mouseout', function(d) { d3.select(this).style('fill-opacity', '100%').style('stroke', null) })

  energy.exit().remove()

  singleElement(pal2, 'path', 'cmpLine').attr('class', 'line')
  .datum(cmp_line)
  .attr('d', 
    d3.svg.line(cmp_line)
    .x(function(d) { return x(d.x) })
    .y(function(d) { return y(d.y) })
  )

  var sel = singleElement(pal2, 'g', 'cmpdots').selectAll('circle').data(cmp_line)
  sel.enter().append('circle')
  sel
    .attr('class', 'cc_vs cmpdot')
    .style('cursor', 'pointer')
    .attr('cx', function(d) { return x(d.x) })
    .attr('cy', function(d) { return y(d.y) })
    .on('click', function(d) { config['show_numbers'] = d.x.getFullYear() + ""; update(); })
    .attr('r', 3.5)
  sel.exit().remove()

  var unitExp = singleElement(svg, 'text', 'unitExplanation')
  .attr('transform', 'translate('+ (width+margin.right) +',' + (height/2) + ') rotate(90)') 
  .attr('dy', '1.51em')
  .attr('text-anchor', 'middle')
  .text(yaxismodemap({'total' : 'Million Tonnes Oil Equivalents per annum',
                      'per_capita' : 'Tonnes Oil Equivalents per Capita per annum',
                      'share' : 'Relative Share of Energy ' + majormode({'consumption': 'Consumption', 'production' : 'Production', net : 'Net Import / Export'})}))

  singleElement(svg, 'text', 'unitExplanationLeft')
  .attr('transform', 'translate('+ (-margin.left) +',' + (height/2) + ') rotate(-90)') 
  .attr('dy', '1.51em')
  .attr('text-anchor', 'middle')
  .text( {'none' : "",
          'percentage' : !is_share_mode() ? "Percentage of All Time High" : unitExp.text(),
          'gdp_capita' : "GDP/Capita in current US Dollars",
          'same' : unitExp.text(),
          'population' : "Population, Million number of People"
          }[left_y_axis()]);

  // newnew
  var y2 = d3.scale.linear().range([height, 0])
  y2.domain([0.0, d3.max(data.filter(function(d) { return !('prop_change' in d) }).map(function(d) { return left_y_fn(d) }))])
  if (left_y_axis() === 'same') {
    y2.domain(y.domain())
  }
  if (left_y_axis() === 'percentage') {
    y2.domain([0.0, 100.0])
  }

  singleElement(pal, 'g', 'yAxisLeft')
  .attr('class', 'y axis')
  .attr("transform", "translate(0,0)")
  .attr('display', left_y_axis() === 'none' ? 'none' : null)
  .call(d3.svg.axis().scale(y2).orient("left"))
  .selectAll('text')
  .attr('class', function(d) { 
    return (left_y_axis()==='same' && is_net_mode() && parseFloat(d3.select(this).text()) != 0.0)  ? (d3.select(this).text().indexOf('-') == 0 ? 'import' : 'export') : null })

  function show_pop_line(idpostfix, pop_line) {
    var show = (left_y_axis() === "same" || left_y_axis() === 'percentage') ? false : true;

    singleElement(pal2, 'path', 'yAxisLeftLine' + idpostfix).attr('class', 'line')
    .datum(pop_line)
    .attr('d', 
      d3.svg.line(pop_line)
      .x(function(d) { return x(d.x) })
      .y(function(d) { return y2(d.y) })
    )
    .style('display', !show ? 'none' : null)

    var sel = singleElement(pal2, 'g', 'leftYAxisLineDots' + idpostfix).selectAll('rect').data(pop_line)
    sel.enter().append('rect')
    var dw = 6;
    var dh = 6;
    sel
      .attr('transform', function(d) { return 'translate(' + x(d.x) + ',' + y2(d.y) + ') rotate(45)' })
      .attr('class', 'heading cc cmpdot')
      .attr('x', function(d) { return -dw/2.0 })
      .attr('y', function(d) { return -dh/2.0 })
      .attr('width', dw)
      .attr('height', dh)
      .style('fill', 'yellow')
      .style('stroke-width', '1.5px')
    sel.exit().remove();
    sel.style('display', !show ? 'none' : null)
    return sel
  }

  show_pop_line('1', pop_line);

  /*
  singleElement(svg, 'g', 'percentage_lines').selectAll('line').data(d3.range(0, 110, 10))
  .enter().append('line')
  .attr('x1', 0).attr('x2', width)
  .attr('y1', function(d) { return y2(d) })
  .attr('y2', function(d) { return y2(d) })
  .style('stroke', 'gray')
  .style('stroke-opacity', '60%')
  */


  var permlink = window.location.href.split('?')[0] + '?country_code=' + cc()
  permlink += is_cc_vs() ? ('&country_code_vs=' + cc_vs()) : ''
  permlink += (yaxismode() !== 'per_capita') ? ('&mode=' + yaxismode()) : ''

  if (resources_array().length != all_resources.split(",").length) {
    permlink += "&resources=" + resources().replace(/_production/g, "").replace(/_net/g, "")
  }
  
  if (is_show_numbers())
    permlink += "&numbers=" + show_numbers()
  if (since().getFullYear() !== 1965)
    permlink += "&since=" + since().getFullYear()
  if (left_y_axis() !== 'same')
    permlink += "&left_y_axis=" + left_y_axis()

  d3.select('#permalink')
  .attr('href', permlink)
  d3.select('#permalink_printer')
  .attr('href', permlink + "&printer=true&image=true")
}

d3.tsv('data/data.tsv', function(err, data) {
  data.forEach(function(d) { countrycodes[d.country_code] = d.country })
  var ccs = d3.set(data.map(function(d) { return d.country_code }))
  var codes = ccs.values().filter(function(d) { return d3.keys(countrycodes).indexOf(d) != -1 })
  var rev = {}
  codes.forEach(function(d) { return rev[countrycodes[d]] = d } )

  var names = d3.keys(rev)
  names.sort()

  names.forEach(function(d) {
    var code = rev[d]
    var id = code.indexOf('BP_') == 0 ? "#groups" : "#countries"
    d3.select(id)
      .append('option')
      .attr('value', rev[d])
      .text(d)
      .attr('selected', cc() === code ? 'selected' : null)

    d3.select(id + "_vs")
      .append('option')
      .attr('value', rev[d])
      .text(d)
      .attr('selected', cc_vs() === code ? 'selected' : null)
  })

  var all_ccs = []

  data.forEach(function(d) {
    if (all_ccs.indexOf(d.country_code) == -1)
      all_ccs.push(d.country_code)
    d.year = format.parse(d.year)
    d.population = +d.population
    d.coal = +d.coal
    d.gas = +d.gas
    d.hydro = +d.hydro
    d.nuclear = +d.nuclear
    d.oil = +d.oil
    d.solar = +d.solar
    d.wind = +d.wind

    d.other_renewables = +d.other_renewables
    d.coal_production = +d.coal_production
    d.oil_production = +d.oil_production
    d.gas_production = +d.gas_production

    d.oil_net = d.oil_production - d.oil
    d.gas_net = d.gas_production - d.gas
    d.coal_net = d.coal_production - d.coal

    d.gdp = +d.gdp
  })

  var newdata = []

  //all_ccs = ['DZ', 'AR', 'AU', 'GB', 'AZ', 'TM']//, 'CN']

  all_ccs.forEach(function(code) {
    var filtered = data.filter(function(d) { return d.country_code === code && d.year >= since() })
    filtered.forEach(function(d, i) {
      if (i>0) {
        var curr = filtered[i]
        var prev = filtered[i-1]
        var changes = []

        if (sign(prev.coal_net) != sign(curr.coal_net)) changes.push('coal_net')
        if (sign(prev.oil_net) != sign(curr.oil_net)) changes.push('oil_net')
        if (sign(prev.gas_net) != sign(curr.gas_net)) changes.push('gas_net')

        if (changes.length>1) {
          //console.log(code)
          //throw 'Whoops'
        }

        var ps = changes.map(function(prop_change) {
          var dy = Math.abs(curr[prop_change] - prev[prop_change])
          var dt = curr.year - prev.year
          var dpopulation = curr.population - prev.population
          var p = Math.abs(0-prev[prop_change]) / dy 
          return {p: p, change : prop_change}
        })
        if (d3.set(ps.map(function(d) { return d.p })).size() != ps.length) {
          console.log('fix the code...')
          throw 'ERROR'
        }
        ps = ps.filter(function(d) { return prev[d.change] != 0 })
        ps.sort(function(a,b) { return a.p-b.p })

        for (var k=0; k<ps.length; k++) {
          var p = ps[k].p
          var prop_changes = ps.filter(function(d) { return d.p == p }).map(function(d) { return d.change })
          if (prop_changes.length > 1) {
            console.log('fix the code...')
            throw 'ERROR'
          }
          var prop_change = prop_changes[0]
          var dy = Math.abs(curr[prop_change] - prev[prop_change])
          var dt = curr.year - prev.year
          var dpopulation = curr.population - prev.population
          var p = Math.abs(0-prev[prop_change]) / dy 
          var newdate = new Date(prev.year.getTime() + parseInt((p*dt)))
          var dat = {country_code: curr.country_code, 
                     year : newdate, 
                     population : curr.population,
                     prop_change : true,
                     oil_net: 'oil_net' === prop_change ? 0.0 : prev.oil_net + p*(curr.oil_net - prev.oil_net), 
                     gas_net: 'gas_net' === prop_change ? 0.0 : prev.gas_net + p*(curr.gas_net - prev.gas_net), 
                     coal_net: 'coal_net' === prop_change ? 0.0 : prev.coal_net + p*(curr.coal_net-prev.coal_net)}
          if (p != 1.0 && p != 0.0)
            newdata.push(dat)
          else { //console.log('skipping ... ' + code) 
          }
        }
      }
      newdata.push(d)
    })
  })

  all_data = newdata
  update()

  singleElement(svg, 'text', 'contact')
  .attr('transform', 'translate(' + (width+margin.right) + ',' + (height+margin.bottom) + ')') 
  .attr('dx', '-.21em')
  .attr('dy', '-.31em')
  .style('text-anchor', 'end')
  .text('Diagram by Refsdal.Ivar@gmail.com')

  singleElement(svg, 'text', 'sources')
  .attr('transform', 'translate(' + (-margin.left) + ',' + (height+margin.bottom) + ')') 
  .attr('dx', '.21em')
  .attr('dy', '-.31em')
  .style('text-anchor', 'start')
  .text('Data from BP Statistical Review and World Bank (2015)')

  if (getURLParameter('printer', 'false') !== 'true') {
    d3.select('body')
    .append('div')
    .html('&quot;Other renewables&quot; includes wind, geothermal, solar, biomass and waste. <a href="https://github.com/ivarref/bp-diagrams">More info about this diagram</a>.')
  }
})

</script>
</body>
